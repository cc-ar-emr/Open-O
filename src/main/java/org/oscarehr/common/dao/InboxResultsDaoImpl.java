                                                                                                                                                                                                                                         
//CHECKSTYLE:OFF                                                                                                                                                                                                                         
/**                                                                                                                                                                                                                                      
 * Copyright (c) 2024. Magenta Health. All Rights Reserved.                                                                                                                                                                              
 * Copyright (c) 2008-2012 Indivica Inc.                                                                                                                                                                                                 
 * <p>                                                                                                                                                                                                                                   
 * This software is made available under the terms of the                                                                                                                                                                                
 * GNU General Public License, Version 2, 1991 (GPLv2).                                                                                                                                                                                  
 * License details are available via "indivica.ca/gplv2"                                                                                                                                                                                 
 * and "gnu.org/licenses/gpl-2.0.html".                                                                                                                                                                                                  
 * <p>                                                                                                                                                                                                                                   
 * Modifications made by Magenta Health in 2024.                                                                                                                                                                                         
 */                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                         
 package org.oscarehr.common.dao;                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
 import java.text.SimpleDateFormat;                                                                                                                                                                                                       
 import java.util.ArrayList;                                                                                                                                                                                                              
 import java.util.Collections;                                                                                                                                                                                                            
 import java.util.Date;                                                                                                                                                                                                                   
 import java.util.List;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                          
 import javax.persistence.EntityManager;                                                                                                                                                                                                  
 import javax.persistence.PersistenceContext;                                                                                                                                                                                             
 import javax.persistence.Query;                                                                                                                                                                                                          
                                                                                                                                                                                                                                          
 import org.apache.http.impl.cookie.DateUtils;                                                                                                                                                                                            
 import org.apache.logging.log4j.Logger;                                                                                                                                                                                                  
 import org.oscarehr.common.model.SystemPreferences;                                                                                                                                                                                      
 import org.oscarehr.util.SpringUtils;                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
 import oscar.oscarLab.ca.on.LabResultData;                                                                                                                                                                                               
 import oscar.util.StringUtils;                                                                                                                                                                                                           
                                                                                                                                                                                                                                          
 public class InboxResultsDaoImpl implements InboxResultsDao {                                                                                                                                                                            
                                                                                                                                                                                                                                           
     Logger logger = org.oscarehr.util.MiscUtils.getLogger();                                                                                                                                                                             
                                                                                                                                                                                                                                          
     @PersistenceContext(unitName = "entityManagerFactory")                                                                                                                                                                               
     protected EntityManager entityManager = null;                                                                                                                                                                                        
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Creates a new instance of Hl7textResultsData                                                                                                                                                                                      
      */                                                                                                                                                                                                                                  
     public InboxResultsDaoImpl() {                                                                                                                                                                                                       
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Populates ArrayList with labs attached to a consultation request                                                                                                                                                                  
      */                                                                                                                                                                                                                                  
     @SuppressWarnings({"unchecked", "rawtypes"})                                                                                                                                                                                         
     public ArrayList populateHL7ResultsData(String demographicNo, String consultationId, boolean attached) {                                                                                                                             
         if (demographicNo == null || consultationId == null) {                                                                                                                                                                           
             logger.error("Invalid parameters: demographicNo or consultationId is null");                                                                                                                                                 
             return new ArrayList<>();                                                                                                                                                                                                    
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         String sql = "SELECT hl7.label, hl7.lab_no, hl7.obr_date, hl7.discipline, hl7.accessionNum, hl7.final_result_count, patientLabRouting.id "                                                                                       
                 + "FROM hl7TextInfo hl7, patientLabRouting "                                                                                                                                                                             
                 + "WHERE patientLabRouting.lab_no = hl7.lab_no "                                                                                                                                                                         
                 + "AND patientLabRouting.lab_type = 'HL7' AND patientLabRouting.demographic_no = ? "                                                                                                                                     
                 + "GROUP BY hl7.lab_no "                                                                                                                                                                                                 
                 + "ORDER BY date(hl7.obr_date) DESC";                                                                                                                                                                                    
                                                                                                                                                                                                                                          
         String attachQuery = "SELECT consultdocs.document_no FROM consultdocs, patientLabRouting "                                                                                                                                       
                 + "WHERE patientLabRouting.id = consultdocs.document_no AND "                                                                                                                                                            
                 + "consultdocs.requestId = ? "                                                                                                                                                                                           
                 + "AND consultdocs.doctype = 'L' AND consultdocs.deleted IS NULL ORDER BY consultdocs.document_no";                                                                                                                      
                                                                                                                                                                                                                                          
         ArrayList labResults = new ArrayList<LabResultData>();                                                                                                                                                                           
         ArrayList attachedLabs = new ArrayList<LabResultData>();                                                                                                                                                                         
                                                                                                                                                                                                                                          
         try {                                                                                                                                                                                                                            
             Query q = entityManager.createNativeQuery(attachQuery);                                                                                                                                                                      
             q.setParameter(1, consultationId);                                                                                                                                                                                           
                                                                                                                                                                                                                                          
             List<Object> result = q.getResultList();                                                                                                                                                                                     
             for (Object r : result) {                                                                                                                                                                                                    
                 LabResultData lbData = new LabResultData(LabResultData.HL7TEXT);                                                                                                                                                         
                 lbData.labPatientId = r.toString();                                                                                                                                                                                      
                 attachedLabs.add(lbData);                                                                                                                                                                                                
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             LabResultData.CompareId c = new LabResultData(LabResultData.HL7TEXT).getComparatorId();                                                                                                                                      
                                                                                                                                                                                                                                          
             q = entityManager.createNativeQuery(sql);                                                                                                                                                                                    
             q.setParameter(1, demographicNo);                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             List<Object[]> resultList = q.getResultList();                                                                                                                                                                               
             for (Object[] r : resultList) {                                                                                                                                                                                              
                 LabResultData lbData = new LabResultData(LabResultData.HL7TEXT);                                                                                                                                                         
                 lbData.segmentID = getStringValue(r[1]);                                                                                                                                                                                 
                 lbData.labPatientId = getStringValue(r[6]);                                                                                                                                                                              
                 lbData.dateTime = getStringValue(r[2]);                                                                                                                                                                                  
                 lbData.discipline = getStringValue(r[3]);                                                                                                                                                                                
                 lbData.accessionNumber = getStringValue(r[4]);                                                                                                                                                                           
                 lbData.finalResultsCount = r[5] != null ? ((Number) r[5]).intValue() : 0;                                                                                                                                                
                 lbData.label = getStringValue(r[0]);                                                                                                                                                                                     
                                                                                                                                                                                                                                          
                 if (attached && Collections.binarySearch(attachedLabs, lbData, c) >= 0)                                                                                                                                                  
                     labResults.add(lbData);                                                                                                                                                                                              
                 else if (!attached && Collections.binarySearch(attachedLabs, lbData, c) < 0)                                                                                                                                             
                     labResults.add(lbData);                                                                                                                                                                                              
             }                                                                                                                                                                                                                            
         } catch (Exception e) {                                                                                                                                                                                                          
             logger.error("Exception in HL7Populate", e);                                                                                                                                                                                 
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         return labResults;                                                                                                                                                                                                               
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     @SuppressWarnings("unchecked")                                                                                                                                                                                                       
     public boolean isSentToProvider(String docNo, String providerNo) {                                                                                                                                                                   
         if (docNo == null || providerNo == null) {                                                                                                                                                                                       
             return false;                                                                                                                                                                                                                
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         try {                                                                                                                                                                                                                            
             int dn = Integer.parseInt(docNo.trim());                                                                                                                                                                                     
             providerNo = providerNo.trim();                                                                                                                                                                                              
                                                                                                                                                                                                                                          
             String sql = "SELECT * FROM providerLabRouting plr WHERE plr.lab_type = 'DOC' AND plr.lab_no = ? AND plr.provider_no = ?";                                                                                                   
                                                                                                                                                                                                                                          
             Query q = entityManager.createNativeQuery(sql);                                                                                                                                                                              
             q.setParameter(1, dn);                                                                                                                                                                                                       
             q.setParameter(2, providerNo);                                                                                                                                                                                               
                                                                                                                                                                                                                                          
             List<Object[]> rs = q.getResultList();                                                                                                                                                                                       
                                                                                                                                                                                                                                          
             logger.debug("isSentToProvider query executed for docNo: " + docNo + ", providerNo: " + providerNo);                                                                                                                         
             return !rs.isEmpty();                                                                                                                                                                                                        
         } catch (NumberFormatException e) {                                                                                                                                                                                              
             logger.error("Invalid document number: " + docNo, e);                                                                                                                                                                        
             return false;                                                                                                                                                                                                                
         } catch (Exception e) {                                                                                                                                                                                                          
             logger.error("Error checking if document is sent to provider", e);                                                                                                                                                           
             return false;                                                                                                                                                                                                                
         }                                                                                                                                                                                                                                
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Wrapper function for non paged document queries.                                                                                                                                                                                  
      */                                                                                                                                                                                                                                  
     @SuppressWarnings("rawtypes")                                                                                                                                                                                                        
     public ArrayList populateDocumentResultsData(String providerNo, String demographicNo, String patientFirstName,                                                                                                                       
                                                  String patientLastName, String patientHealthNumber, String status) {                                                                                                                    
         return populateDocumentResultsData(providerNo, demographicNo, patientFirstName, patientLastName,                                                                                                                                 
                 patientHealthNumber, status, false, null, null, false, null);                                                                                                                                                            
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     @SuppressWarnings({"unchecked", "deprecation"})                                                                                                                                                                                      
     public ArrayList<LabResultData> populateDocumentResultsData(String providerNo, String demographicNo, String patientFirstName,                                                                                                        
                                                                 String patientLastName, String patientHealthNumber, String status, boolean isPaged, Integer page,                                                                        
                                                                 Integer pageSize, boolean mixLabsAndDocs, Boolean isAbnormal) {                                                                                                          
                                                                                                                                                                                                                                          
         return populateDocumentResultsData(providerNo, demographicNo, patientFirstName, patientLastName, patientHealthNumber, status, isPaged, page, pageSize, mixLabsAndDocs, isAbnormal, null, null);                                  
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     @SuppressWarnings({"unchecked"})                                                                                                                                                                                                     
     public ArrayList<LabResultData> populateDocumentResultsData(String providerNo, String demographicNo, String patientFirstName,                                                                                                        
                                                                 String patientLastName, String patientHealthNumber, String status, boolean isPaged, Integer page,                                                                        
                                                                 Integer pageSize, boolean mixLabsAndDocs, Boolean isAbnormal, Date startDate, Date endDate) {                                                                            
         // Normalize input parameters                                                                                                                                                                                                    
         if (providerNo == null) {                                                                                                                                                                                                        
             providerNo = "";                                                                                                                                                                                                             
         }                                                                                                                                                                                                                                
         boolean searchProvider = !"-1".equals(providerNo);                                                                                                                                                                               
                                                                                                                                                                                                                                          
         if (patientFirstName == null) {                                                                                                                                                                                                  
             patientFirstName = "";                                                                                                                                                                                                       
         }                                                                                                                                                                                                                                
         if (patientLastName == null) {                                                                                                                                                                                                   
             patientLastName = "";                                                                                                                                                                                                        
         }                                                                                                                                                                                                                                
         if (patientHealthNumber == null) {                                                                                                                                                                                               
             patientHealthNumber = "";                                                                                                                                                                                                    
         }                                                                                                                                                                                                                                
         boolean patientSearch = !"".equals(patientFirstName) || !"".equals(patientLastName)                                                                                                                                              
                 || !"".equals(patientHealthNumber);                                                                                                                                                                                      
                                                                                                                                                                                                                                          
         if (status == null) {                                                                                                                                                                                                            
             status = "";                                                                                                                                                                                                                 
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         SystemPreferencesDao systemPreferencesDao = SpringUtils.getBean(SystemPreferencesDao.class);                                                                                                                                     
         ArrayList<LabResultData> labResults = new ArrayList<LabResultData>();                                                                                                                                                            
                                                                                                                                                                                                                                          
         // Determine date search type from system preferences                                                                                                                                                                            
         String dateSearchType = "serviceObservation";                                                                                                                                                                                    
         SystemPreferences systemPreferences = systemPreferencesDao.findPreferenceByName(SystemPreferences.LAB_DISPLAY_PREFERENCE_KEYS.inboxDateSearchType);                                                                              
         if (systemPreferences != null && systemPreferences.getValue() != null && !systemPreferences.getValue().isEmpty()) {                                                                                                              
             dateSearchType = systemPreferences.getValue();                                                                                                                                                                               
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         String dateField = dateSearchType.equals("receivedCreated") ? "doc.contentdatetime" : "doc.observationdate";                                                                                                                     
         SimpleDateFormat dateSqlFormatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");                                                                                                                                                 
                                                                                                                                                                                                                                          
         // Build query based on parameters                                                                                                                                                                                               
         try {                                                                                                                                                                                                                            
             String sql;                                                                                                                                                                                                                  
             Query q;                                                                                                                                                                                                                     
                                                                                                                                                                                                                                          
             // Different query paths based on demographic and other parameters                                                                                                                                                           
             if ("0".equals(demographicNo)) {                                                                                                                                                                                             
                 sql = buildQueryForUnassignedDocuments(providerNo, status, dateField, startDate, endDate,                                                                                                                                
                         isAbnormal, isPaged, page, pageSize, mixLabsAndDocs, dateSqlFormatter);                                                                                                                                          
                 q = createQueryWithParameters(sql, providerNo, status, startDate, endDate, isAbnormal,                                                                                                                                   
                         isPaged, page, pageSize, searchProvider);                                                                                                                                                                        
             } else if (demographicNo != null && !"".equals(demographicNo)) {                                                                                                                                                             
                 sql = buildQueryForSpecificDemographic(providerNo, demographicNo, status, dateField,                                                                                                                                     
                         startDate, endDate, isAbnormal, isPaged, page, pageSize, mixLabsAndDocs,                                                                                                                                         
                         dateSqlFormatter);                                                                                                                                                                                               
                 q = createQueryWithParameters(sql, providerNo, demographicNo, status, startDate, endDate,                                                                                                                                
                         isAbnormal, isPaged, page, pageSize, searchProvider);                                                                                                                                                            
             } else if (patientSearch) {                                                                                                                                                                                                  
                 sql = buildQueryForPatientSearch(providerNo, patientFirstName, patientLastName,                                                                                                                                          
                         patientHealthNumber, status, dateField, startDate, endDate, isAbnormal,                                                                                                                                          
                         isPaged, page, pageSize, mixLabsAndDocs, dateSqlFormatter);                                                                                                                                                      
                 q = createQueryWithPatientSearchParameters(sql, providerNo, patientFirstName, patientLastName,                                                                                                                           
                         patientHealthNumber, status, startDate, endDate, isAbnormal, isPaged, page,                                                                                                                                      
                         pageSize, searchProvider);                                                                                                                                                                                       
             } else {                                                                                                                                                                                                                     
                 sql = buildQueryForAllDocuments(providerNo, status, dateField, startDate, endDate,                                                                                                                                       
                         isAbnormal, isPaged, page, pageSize, mixLabsAndDocs, dateSqlFormatter);                                                                                                                                          
                 q = createQueryWithParameters(sql, providerNo, status, startDate, endDate, isAbnormal,                                                                                                                                   
                         isPaged, page, pageSize, searchProvider);                                                                                                                                                                        
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             logger.debug("Document query: " + sql);                                                                                                                                                                                      
                                                                                                                                                                                                                                          
             List<Object[]> result = q.getResultList();                                                                                                                                                                                   
                                                                                                                                                                                                                                          
             // Process results                                                                                                                                                                                                           
             for (Object[] r : result) {                                                                                                                                                                                                  
                 LabResultData lbData = processDocumentResultRow(r, demographicNo, providerNo, dateSearchType);                                                                                                                           
                 if (lbData != null) {                                                                                                                                                                                                    
                     labResults.add(lbData);                                                                                                                                                                                              
                 }                                                                                                                                                                                                                        
             }                                                                                                                                                                                                                            
         } catch (Exception e) {                                                                                                                                                                                                          
             logger.error("Exception in populateDocumentResultsData", e);                                                                                                                                                                 
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         return labResults;                                                                                                                                                                                                               
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Creates a query with parameters for standard queries                                                                                                                                                                              
      */                                                                                                                                                                                                                                  
     private Query createQueryWithParameters(String sql, String providerNo, String status,                                                                                                                                                
                                            Date startDate, Date endDate, Boolean isAbnormal,                                                                                                                                             
                                            boolean isPaged, Integer page, Integer pageSize,                                                                                                                                              
                                            boolean searchProvider) {                                                                                                                                                                     
         Query q = entityManager.createNativeQuery(sql);                                                                                                                                                                                  
         int paramIndex = 1;                                                                                                                                                                                                              
                                                                                                                                                                                                                                          
         // Add status parameter if needed                                                                                                                                                                                                
         if (!"".equals(status)) {                                                                                                                                                                                                        
             q.setParameter(paramIndex++, status);                                                                                                                                                                                        
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         // Add provider parameter if needed                                                                                                                                                                                              
         if (searchProvider && !"".equals(providerNo)) {                                                                                                                                                                                  
             q.setParameter(paramIndex++, providerNo);                                                                                                                                                                                    
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         // Add date parameters if needed                                                                                                                                                                                                 
         if (startDate != null) {                                                                                                                                                                                                         
             q.setParameter(paramIndex++, startDate);                                                                                                                                                                                     
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         if (endDate != null) {                                                                                                                                                                                                           
             q.setParameter(paramIndex++, endDate);                                                                                                                                                                                       
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         // Add pagination parameters if needed                                                                                                                                                                                           
         if (isPaged && page != null && pageSize != null) {                                                                                                                                                                               
             q.setParameter(paramIndex++, page * pageSize);                                                                                                                                                                               
             q.setParameter(paramIndex++, pageSize);                                                                                                                                                                                      
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         return q;                                                                                                                                                                                                                        
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Creates a query with parameters for demographic-specific queries                                                                                                                                                                  
      */                                                                                                                                                                                                                                  
     private Query createQueryWithParameters(String sql, String providerNo, String demographicNo,                                                                                                                                         
                                            String status, Date startDate, Date endDate,                                                                                                                                                  
                                            Boolean isAbnormal, boolean isPaged, Integer page,                                                                                                                                            
                                            Integer pageSize, boolean searchProvider) {                                                                                                                                                   
         Query q = entityManager.createNativeQuery(sql);                                                                                                                                                                                  
         int paramIndex = 1;                                                                                                                                                                                                              
                                                                                                                                                                                                                                          
         // Add demographic parameter                                                                                                                                                                                                     
         q.setParameter(paramIndex++, demographicNo);                                                                                                                                                                                     
                                                                                                                                                                                                                                          
         // Add status parameter if needed                                                                                                                                                                                                
         if (!"".equals(status)) {                                                                                                                                                                                                        
             q.setParameter(paramIndex++, status);                                                                                                                                                                                        
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         // Add provider parameter if needed                                                                                                                                                                                              
         if (searchProvider && !"".equals(providerNo)) {                                                                                                                                                                                  
             q.setParameter(paramIndex++, providerNo);                                                                                                                                                                                    
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         // Add date parameters if needed                                                                                                                                                                                                 
         if (startDate != null) {                                                                                                                                                                                                         
             q.setParameter(paramIndex++, startDate);                                                                                                                                                                                     
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         if (endDate != null) {                                                                                                                                                                                                           
             q.setParameter(paramIndex++, endDate);                                                                                                                                                                                       
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         // Add pagination parameters if needed                                                                                                                                                                                           
         if (isPaged && page != null && pageSize != null) {                                                                                                                                                                               
             q.setParameter(paramIndex++, page * pageSize);                                                                                                                                                                               
             q.setParameter(paramIndex++, pageSize);                                                                                                                                                                                      
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         return q;                                                                                                                                                                                                                        
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Creates a query with parameters for patient search queries                                                                                                                                                                        
      */                                                                                                                                                                                                                                  
     private Query createQueryWithPatientSearchParameters(String sql, String providerNo,                                                                                                                                                  
                                                         String patientFirstName, String patientLastName,                                                                                                                                 
                                                         String patientHealthNumber, String status,                                                                                                                                       
                                                         Date startDate, Date endDate, Boolean isAbnormal,                                                                                                                                
                                                         boolean isPaged, Integer page, Integer pageSize,                                                                                                                                 
                                                         boolean searchProvider) {                                                                                                                                                        
         Query q = entityManager.createNativeQuery(sql);                                                                                                                                                                                  
         int paramIndex = 1;                                                                                                                                                                                                              
                                                                                                                                                                                                                                          
         // Add patient search parameters                                                                                                                                                                                                 
         q.setParameter(paramIndex++, "%" + patientFirstName + "%");                                                                                                                                                                      
         q.setParameter(paramIndex++, "%" + patientLastName + "%");                                                                                                                                                                       
         q.setParameter(paramIndex++, "%" + patientHealthNumber + "%");                                                                                                                                                                   
                                                                                                                                                                                                                                          
         // Add status parameter if needed                                                                                                                                                                                                
         if (!"".equals(status)) {                                                                                                                                                                                                        
             q.setParameter(paramIndex++, status);                                                                                                                                                                                        
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         // Add provider parameter if needed                                                                                                                                                                                              
         if (searchProvider && !"".equals(providerNo)) {                                                                                                                                                                                  
             q.setParameter(paramIndex++, providerNo);                                                                                                                                                                                    
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         // Add date parameters if needed                                                                                                                                                                                                 
         if (startDate != null) {                                                                                                                                                                                                         
             q.setParameter(paramIndex++, startDate);                                                                                                                                                                                     
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         if (endDate != null) {                                                                                                                                                                                                           
             q.setParameter(paramIndex++, endDate);                                                                                                                                                                                       
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         // Add pagination parameters if needed                                                                                                                                                                                           
         if (isPaged && page != null && pageSize != null) {                                                                                                                                                                               
             q.setParameter(paramIndex++, page * pageSize);                                                                                                                                                                               
             q.setParameter(paramIndex++, pageSize);                                                                                                                                                                                      
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         return q;                                                                                                                                                                                                                        
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Builds query for unassigned documents (demographicNo = 0)                                                                                                                                                                         
      */                                                                                                                                                                                                                                  
     private String buildQueryForUnassignedDocuments(String providerNo, String status, String dateField,                                                                                                                                  
                                                   Date startDate, Date endDate, Boolean isAbnormal,                                                                                                                                      
                                                   boolean isPaged, Integer page, Integer pageSize,                                                                                                                                       
                                                   boolean mixLabsAndDocs, SimpleDateFormat dateSqlFormatter) {                                                                                                                           
         StringBuilder sql = new StringBuilder();                                                                                                                                                                                         
                                                                                                                                                                                                                                          
         if (mixLabsAndDocs) {                                                                                                                                                                                                            
             sql.append("SELECT X.id, X.lab_no as document_no, X.status, X.lab_type as doctype, d.last_name, d.first_name, hin, sex, d.demographic_no as module_id, ")                                                                    
                .append(dateField).append(", doc.doctype as description, date(doc.updatedatetime) ")                                                                                                                                      
                .append("FROM document doc, ")                                                                                                                                                                                            
                .append("(SELECT plr.id, plr.lab_type, plr.lab_no, plr.status ")                                                                                                                                                          
                .append("FROM patientLabRouting plr2, providerLabRouting plr, hl7TextInfo info ")                                                                                                                                         
                .append("WHERE plr.lab_no = plr2.lab_no ");                                                                                                                                                                               
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ")                                                                                                                                            
                .append("AND plr.lab_type = 'HL7' ")                                                                                                                                                                                      
                .append("AND plr2.lab_type = 'HL7' ")                                                                                                                                                                                     
                .append("AND plr2.demographic_no = '0' ")                                                                                                                                                                                 
                .append("AND info.lab_no = plr.lab_no ");                                                                                                                                                                                 
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(isAbnormal ? "AND info.result_status = 'A' " : "AND (info.result_status IS NULL OR info.result_status != 'A') ");                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("UNION ")                                                                                                                                                                                                         
                .append("SELECT plr.id, plr.lab_type, plr.lab_no, plr.status ")                                                                                                                                                           
                .append("FROM providerLabRouting plr, ctl_document cd ")                                                                                                                                                                  
                .append("WHERE plr.lab_type = 'DOC' ")                                                                                                                                                                                    
                .append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ")                                                                                                                                            
                .append("AND cd.document_no = plr.lab_no ")                                                                                                                                                                               
                .append("AND cd.module_id = -1 ");                                                                                                                                                                                        
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("ORDER BY id DESC ")                                                                                                                                                                                              
                .append(") AS X ")                                                                                                                                                                                                        
                .append("LEFT JOIN demographic d ")                                                                                                                                                                                       
                .append("ON d.demographic_no = -1 ")                                                                                                                                                                                      
                .append("WHERE X.lab_type = 'DOC' AND doc.document_no = X.lab_no ");                                                                                                                                                      
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(isAbnormal ? "AND doc.abnormal = TRUE " : "AND (doc.abnormal = FALSE OR doc.abnormal IS NULL) ");                                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Add date conditions                                                                                                                                                                                                       
             if (startDate != null) {                                                                                                                                                                                                     
                 sql.append("AND ").append(dateField).append(" >= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (endDate != null) {                                                                                                                                                                                                       
                 sql.append("AND ").append(dateField).append(" <= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("GROUP BY doc.document_no ")                                                                                                                                                                                      
                .append("ORDER BY ").append(dateField).append(" DESC, doc.document_no DESC ");                                                                                                                                            
                                                                                                                                                                                                                                          
             if (isPaged && page != null && pageSize != null) {                                                                                                                                                                           
                 sql.append("LIMIT ?, ?");                                                                                                                                                                                                
             }                                                                                                                                                                                                                            
         } else {                                                                                                                                                                                                                         
             sql.append("SELECT plr.id, doc.document_no, plr.status, demographic_no as module_id, ")                                                                                                                                      
                .append(dateField).append(", plr.lab_type as doctype, last_name, first_name, hin, sex, docdesc, date(doc.updatedatetime) as updateDateLoc ")                                                                              
                .append("FROM providerLabRouting plr ")                                                                                                                                                                                   
                .append("LEFT JOIN document doc ON doc.document_no = plr.lab_no ")                                                                                                                                                        
                .append("RIGHT JOIN ctl_document cd ON cd.document_no = plr.lab_no AND cd.module_id = -1 ")                                                                                                                               
                .append("LEFT JOIN demographic d ON d.demographic_no = -1 ")                                                                                                                                                              
                .append("WHERE plr.lab_type = 'DOC' ")                                                                                                                                                                                    
                .append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(isAbnormal ? "AND doc.abnormal = TRUE " : "AND (doc.abnormal = FALSE OR doc.abnormal IS NULL) ");                                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Add date conditions                                                                                                                                                                                                       
             if (startDate != null) {                                                                                                                                                                                                     
                 sql.append("AND ").append(dateField).append(" >= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (endDate != null) {                                                                                                                                                                                                       
                 sql.append("AND ").append(dateField).append(" <= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("GROUP BY doc.document_no ")                                                                                                                                                                                      
                .append("ORDER BY ").append(dateField).append(" DESC ");                                                                                                                                                                  
                                                                                                                                                                                                                                          
             if (isPaged && page != null && pageSize != null) {                                                                                                                                                                           
                 sql.append("LIMIT ?, ?");                                                                                                                                                                                                
             }                                                                                                                                                                                                                            
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         return sql.toString();                                                                                                                                                                                                           
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Builds query for a specific demographic                                                                                                                                                                                           
      */                                                                                                                                                                                                                                  
     private String buildQueryForSpecificDemographic(String providerNo, String demographicNo, String status,                                                                                                                              
                                                   String dateField, Date startDate, Date endDate,                                                                                                                                        
                                                   Boolean isAbnormal, boolean isPaged, Integer page,                                                                                                                                     
                                                   Integer pageSize, boolean mixLabsAndDocs,                                                                                                                                              
                                                   SimpleDateFormat dateSqlFormatter) {                                                                                                                                                   
         StringBuilder sql = new StringBuilder();                                                                                                                                                                                         
                                                                                                                                                                                                                                          
         if (mixLabsAndDocs) {                                                                                                                                                                                                            
             sql.append("SELECT plr.id, doc.document_no, plr.status, d.last_name, d.first_name, hin, sex, d.demographic_no as module_id, ")                                                                                               
                .append(dateField).append(", plr.lab_type as doctype, doc.doctype as description, date(doc.updatedatetime) ")                                                                                                             
                .append("FROM demographic d, providerLabRouting plr, document doc, ")                                                                                                                                                     
                .append("(SELECT * FROM ")                                                                                                                                                                                                
                .append("(SELECT DISTINCT plr.id, plr.lab_type FROM providerLabRouting plr, ctl_document cd ")                                                                                                                            
                .append("WHERE (cd.module_id = ? ")                                                                                                                                                                                       
                .append("AND cd.document_no = plr.lab_no ")                                                                                                                                                                               
                .append("AND plr.lab_type = 'DOC' ")                                                                                                                                                                                      
                .append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append(") ORDER BY id DESC) AS Y ")                                                                                                                                                                                      
                .append("UNION ")                                                                                                                                                                                                         
                .append("SELECT * FROM ")                                                                                                                                                                                                 
                .append("(SELECT DISTINCT plr.id, plr.lab_type FROM providerLabRouting plr, patientLabRouting plr2 ")                                                                                                                     
                .append("WHERE plr.lab_type = 'HL7' AND plr2.lab_type = 'HL7' ")                                                                                                                                                          
                .append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("AND plr.lab_no = plr2.lab_no AND plr2.demographic_no = ? ")                                                                                                                                                      
                .append("ORDER BY id DESC) AS Z ")                                                                                                                                                                                        
                .append("ORDER BY id DESC ")                                                                                                                                                                                              
                .append(") AS X ")                                                                                                                                                                                                        
                .append("WHERE X.lab_type = 'DOC' AND X.id = plr.id AND doc.document_no = plr.lab_no AND d.demographic_no = ? ");                                                                                                         
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(isAbnormal ? "AND doc.abnormal = TRUE " : "AND (doc.abnormal = FALSE OR doc.abnormal IS NULL) ");                                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Add date conditions                                                                                                                                                                                                       
             if (startDate != null) {                                                                                                                                                                                                     
                 sql.append("AND ").append(dateField).append(" >= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (endDate != null) {                                                                                                                                                                                                       
                 sql.append("AND ").append(dateField).append(" <= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("GROUP BY doc.document_no ")                                                                                                                                                                                      
                .append("ORDER BY ").append(dateField).append(" DESC, doc.document_no DESC ");                                                                                                                                            
                                                                                                                                                                                                                                          
             if (isPaged && page != null && pageSize != null) {                                                                                                                                                                           
                 sql.append("LIMIT ?, ?");                                                                                                                                                                                                
             }                                                                                                                                                                                                                            
         } else {                                                                                                                                                                                                                         
             sql.append("SELECT plr.id, doc.document_no, plr.status, last_name, first_name, hin, sex, module_id, ")                                                                                                                       
                .append(dateField).append(", plr.lab_type as doctype, doc.doctype as description, date(doc.updatedatetime) ")                                                                                                             
                .append("FROM ctl_document cd, demographic d, providerLabRouting plr, document doc ")                                                                                                                                     
                .append("WHERE d.demographic_no = ? ")                                                                                                                                                                                    
                .append("AND cd.module_id = d.demographic_no ")                                                                                                                                                                           
                .append("AND cd.document_no = plr.lab_no ")                                                                                                                                                                               
                .append("AND plr.lab_type = 'DOC' ")                                                                                                                                                                                      
                .append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("AND doc.document_no = cd.document_no ");                                                                                                                                                                         
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(isAbnormal ? "AND doc.abnormal = TRUE " : "AND (doc.abnormal = FALSE OR doc.abnormal IS NULL) ");                                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Add date conditions                                                                                                                                                                                                       
             if (startDate != null) {                                                                                                                                                                                                     
                 sql.append("AND ").append(dateField).append(" >= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (endDate != null) {                                                                                                                                                                                                       
                 sql.append("AND ").append(dateField).append(" <= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("GROUP BY doc.document_no ")                                                                                                                                                                                      
                .append("ORDER BY ").append(dateField).append(" DESC ");                                                                                                                                                                  
                                                                                                                                                                                                                                          
             if (isPaged && page != null && pageSize != null) {                                                                                                                                                                           
                 sql.append("LIMIT ?, ?");                                                                                                                                                                                                
             }                                                                                                                                                                                                                            
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         return sql.toString();                                                                                                                                                                                                           
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Builds query for patient search                                                                                                                                                                                                   
      */                                                                                                                                                                                                                                  
     private String buildQueryForPatientSearch(String providerNo, String patientFirstName, String patientLastName,                                                                                                                        
                                             String patientHealthNumber, String status, String dateField,                                                                                                                                 
                                             Date startDate, Date endDate, Boolean isAbnormal,                                                                                                                                            
                                             boolean isPaged, Integer page, Integer pageSize, boolean mixLabsAndDocs,                                                                                                                     
                                             SimpleDateFormat dateSqlFormatter) {                                                                                                                                                         
         StringBuilder sql = new StringBuilder();                                                                                                                                                                                         
                                                                                                                                                                                                                                          
         if (mixLabsAndDocs) {                                                                                                                                                                                                            
             sql.append("SELECT plr.id, doc.document_no, plr.status, d.last_name, d.first_name, hin, sex, d.demographic_no as module_id, ")                                                                                               
                .append(dateField).append(", plr.lab_type as doctype, doc.doctype as description, date(doc.updatedatetime) ")                                                                                                             
                .append("FROM demographic d, providerLabRouting plr, document doc, ")                                                                                                                                                     
                .append("(SELECT * FROM ")                                                                                                                                                                                                
                .append("(SELECT * FROM ")                                                                                                                                                                                                
                .append("(SELECT DISTINCT plr.id, plr.lab_type, d.demographic_no ")                                                                                                                                                       
                .append("FROM providerLabRouting plr, ctl_document cd, demographic d ")                                                                                                                                                   
                .append("WHERE (d.first_name LIKE ? AND d.last_name LIKE ? AND d.hin LIKE ? ")                                                                                                                                            
                .append("AND cd.module_id = d.demographic_no AND cd.document_no = plr.lab_no AND plr.lab_type = 'DOC' ")                                                                                                                  
                .append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append(") ORDER BY id DESC) AS Y ")                                                                                                                                                                                      
                .append("UNION ")                                                                                                                                                                                                         
                .append("SELECT * FROM ")                                                                                                                                                                                                 
                .append("(SELECT DISTINCT plr.id, plr.lab_type, d.demographic_no ")                                                                                                                                                       
                .append("FROM providerLabRouting plr, patientLabRouting plr2, demographic d ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(", hl7TextInfo info ");                                                                                                                                                                                       
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("WHERE d.first_name LIKE ? AND d.last_name LIKE ? AND d.hin LIKE ? ")                                                                                                                                             
                .append("AND plr.lab_type = 'HL7' AND plr2.lab_type = 'HL7' ");                                                                                                                                                           
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append("AND plr.lab_no = info.lab_no AND ")                                                                                                                                                                          
                    .append(isAbnormal ? "info.result_status = 'A' " : "(info.result_status IS NULL OR info.result_status != 'A') ");                                                                                                     
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("AND plr.lab_no = plr2.lab_no AND plr2.demographic_no = d.demographic_no ORDER BY id DESC) AS Z ")                                                                                                                
                .append("ORDER BY id DESC) AS X ")                                                                                                                                                                                        
                .append(") AS Z ")                                                                                                                                                                                                        
                .append("WHERE Z.lab_type = 'DOC' AND Z.id = plr.id AND doc.document_no = plr.lab_no AND d.demographic_no = Z.demographic_no ");                                                                                          
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(isAbnormal ? "AND doc.abnormal = TRUE " : "AND (doc.abnormal = FALSE OR doc.abnormal IS NULL) ");                                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Add date conditions                                                                                                                                                                                                       
             if (startDate != null) {                                                                                                                                                                                                     
                 sql.append("AND ").append(dateField).append(" >= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (endDate != null) {                                                                                                                                                                                                       
                 sql.append("AND ").append(dateField).append(" <= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("GROUP BY doc.document_no ")                                                                                                                                                                                      
                .append("ORDER BY ").append(dateField).append(" DESC, doc.document_no DESC ");                                                                                                                                            
                                                                                                                                                                                                                                          
             if (isPaged && page != null && pageSize != null) {                                                                                                                                                                           
                 sql.append("LIMIT ?, ?");                                                                                                                                                                                                
             }                                                                                                                                                                                                                            
         } else {                                                                                                                                                                                                                         
             sql.append("SELECT plr.id, doc.document_no, plr.status, last_name, first_name, hin, sex, module_id, ")                                                                                                                       
                .append(dateField).append(", plr.lab_type as doctype, doc.doctype as description, date(doc.updatedatetime) ")                                                                                                             
                .append("FROM ctl_document cd, demographic d, providerLabRouting plr, document doc ")                                                                                                                                     
                .append("WHERE d.first_name LIKE ? AND d.last_name LIKE ? AND d.hin LIKE ? ")                                                                                                                                             
                .append("AND cd.module_id = d.demographic_no ")                                                                                                                                                                           
                .append("AND cd.document_no = plr.lab_no ")                                                                                                                                                                               
                .append("AND plr.lab_type = 'DOC' ")                                                                                                                                                                                      
                .append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("AND doc.document_no = cd.document_no ");                                                                                                                                                                         
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(isAbnormal ? "AND doc.abnormal = TRUE " : "AND (doc.abnormal = FALSE OR doc.abnormal IS NULL) ");                                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Add date conditions                                                                                                                                                                                                       
             if (startDate != null) {                                                                                                                                                                                                     
                 sql.append("AND ").append(dateField).append(" >= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (endDate != null) {                                                                                                                                                                                                       
                 sql.append("AND ").append(dateField).append(" <= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("GROUP BY doc.document_no ")                                                                                                                                                                                      
                .append("ORDER BY ").append(dateField).append(" DESC ");                                                                                                                                                                  
                                                                                                                                                                                                                                          
             if (isPaged && page != null && pageSize != null) {                                                                                                                                                                           
                 sql.append("LIMIT ?, ?");                                                                                                                                                                                                
             }                                                                                                                                                                                                                            
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         return sql.toString();                                                                                                                                                                                                           
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Builds query for all documents                                                                                                                                                                                                    
      */                                                                                                                                                                                                                                  
     private String buildQueryForAllDocuments(String providerNo, String status, String dateField,                                                                                                                                         
                                            Date startDate, Date endDate, Boolean isAbnormal,                                                                                                                                             
                                            boolean isPaged, Integer page, Integer pageSize, boolean mixLabsAndDocs,                                                                                                                      
                                            SimpleDateFormat dateSqlFormatter) {                                                                                                                                                          
         StringBuilder sql = new StringBuilder();                                                                                                                                                                                         
                                                                                                                                                                                                                                          
         if (mixLabsAndDocs) {                                                                                                                                                                                                            
             sql.append("SELECT doc.document_no, plr.status, d.last_name, d.first_name, d.hin, d.sex, cd.module_id, ")                                                                                                                    
                .append(dateField).append(", plr.lab_type, doc.doctype, date(doc.updatedatetime) ")                                                                                                                                       
                .append("FROM document doc ")                                                                                                                                                                                             
                .append("LEFT JOIN providerLabRouting plr ON doc.document_no = plr.lab_no ")                                                                                                                                              
                .append("LEFT JOIN ctl_document cd ON cd.document_no = doc.document_no ")                                                                                                                                                 
                .append("LEFT JOIN demographic d ON cd.module_id = d.demographic_no ")                                                                                                                                                    
                .append("WHERE plr.lab_type = 'DOC' ");                                                                                                                                                                                   
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(isAbnormal ? "AND doc.abnormal = TRUE " : "AND (doc.abnormal = FALSE OR doc.abnormal IS NULL) ");                                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Add date conditions                                                                                                                                                                                                       
             if (startDate != null) {                                                                                                                                                                                                     
                 sql.append("AND ").append(dateField).append(" >= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (endDate != null) {                                                                                                                                                                                                       
                 sql.append("AND ").append(dateField).append(" <= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("GROUP BY doc.document_no ")                                                                                                                                                                                      
                .append("ORDER BY ").append(dateField).append(" DESC ");                                                                                                                                                                  
                                                                                                                                                                                                                                          
             if (isPaged && page != null && pageSize != null) {                                                                                                                                                                           
                 sql.append("LIMIT ?, ?");                                                                                                                                                                                                
             }                                                                                                                                                                                                                            
         } else {                                                                                                                                                                                                                         
             sql.append("SELECT * FROM ")                                                                                                                                                                                                 
                .append("(SELECT plr.id, doc.document_no, plr.status, last_name, first_name, hin, sex, module_id, ")                                                                                                                      
                .append(dateField).append(", plr.lab_type as doctype, docdesc, updatedatetime ")                                                                                                                                          
                .append("FROM ctl_document cd, demographic d, providerLabRouting plr, document doc ")                                                                                                                                     
                .append("WHERE (cd.module_id = d.demographic_no) ")                                                                                                                                                                       
                .append("AND cd.document_no = plr.lab_no ")                                                                                                                                                                               
                .append("AND plr.lab_type = 'DOC' ")                                                                                                                                                                                      
                .append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("AND doc.document_no = cd.document_no ");                                                                                                                                                                         
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(isAbnormal ? "AND doc.abnormal = TRUE " : "AND (doc.abnormal = FALSE OR doc.abnormal IS NULL) ");                                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Add date conditions                                                                                                                                                                                                       
             if (startDate != null) {                                                                                                                                                                                                     
                 sql.append("AND ").append(dateField).append(" >= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (endDate != null) {                                                                                                                                                                                                       
                 sql.append("AND ").append(dateField).append(" <= ? ");                                                                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("UNION ")                                                                                                                                                                                                         
                .append("SELECT X.id, X.lab_no as document_no, X.status, last_name, first_name, hin, sex, X.module_id, ")                                                                                                                 
                .append(dateField).append(", X.lab_type as doctype, docdesc, updatedatetime ")                                                                                                                                            
                .append("FROM (SELECT plr.id, plr.lab_no, plr.status, plr.lab_type, cd.module_id, ")                                                                                                                                      
                .append(dateField).append(", docdesc, updatedatetime ")                                                                                                                                                                   
                .append("FROM ctl_document cd, providerLabRouting plr, document d ")                                                                                                                                                      
                .append("WHERE plr.lab_type = 'DOC' ")                                                                                                                                                                                    
                .append("AND plr.status ").append("".equals(status) ? "IS NOT NULL " : "= ? ");                                                                                                                                           
                                                                                                                                                                                                                                          
             if (!"".equals(providerNo) && !"-1".equals(providerNo)) {                                                                                                                                                                    
                 sql.append("AND plr.provider_no = ? ");                                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append("AND plr.lab_no = cd.document_no ")                                                                                                                                                                               
                .append("AND cd.module_id = -1 ")                                                                                                                                                                                         
                .append("AND d.document_no = cd.document_no ");                                                                                                                                                                           
                                                                                                                                                                                                                                          
             if (isAbnormal != null) {                                                                                                                                                                                                    
                 sql.append(isAbnormal ? "AND d.abnormal = TRUE " : "AND (d.abnormal = FALSE OR d.abnormal IS NULL) ");                                                                                                                   
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Add date conditions for the subquery                                                                                                                                                                                      
             if (startDate != null) {                                                                                                                                                                                                     
                 sql.append("AND ").append(dateField.replace("doc.", "d.")).append(" >= ? ");                                                                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (endDate != null) {                                                                                                                                                                                                       
                 sql.append("AND ").append(dateField.replace("doc.", "d.")).append(" <= ? ");                                                                                                                                             
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             sql.append(") AS X ")                                                                                                                                                                                                        
                .append("LEFT JOIN demographic d ")                                                                                                                                                                                       
                .append("ON d.demographic_no = -1 ")                                                                                                                                                                                      
                .append(") AS X ")                                                                                                                                                                                                        
                .append("GROUP BY document_no ")                                                                                                                                                                                          
                .append("ORDER BY ").append(dateField.replace("doc.", "")).append(" DESC ");                                                                                                                                              
                                                                                                                                                                                                                                          
             if (isPaged && page != null && pageSize != null) {                                                                                                                                                                           
                 sql.append("LIMIT ?, ?");                                                                                                                                                                                                
             }                                                                                                                                                                                                                            
         }                                                                                                                                                                                                                                
                                                                                                                                                                                                                                          
         return sql.toString();                                                                                                                                                                                                           
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     /**                                                                                                                                                                                                                                  
      * Processes a result row and converts it to a LabResultData object                                                                                                                                                                  
      */                                                                                                                                                                                                                                  
     private LabResultData processDocumentResultRow(Object[] row, String demographicNo, String providerNo, String dateSearchType) {                                                                                                       
         try {                                                                                                                                                                                                                            
             LabResultData lbData = new LabResultData(LabResultData.DOCUMENT);                                                                                                                                                            
             lbData.labType = LabResultData.DOCUMENT;                                                                                                                                                                                     
                                                                                                                                                                                                                                          
             // Determine column indices based on the query structure                                                                                                                                                                     
             int docNoLoc, statusLoc, lastNameLoc, firstNameLoc, hinLoc, sexLoc, moduleLoc, obsDateLoc, docTypeLoc, descriptionLoc, updateDateLoc;                                                                                        
                                                                                                                                                                                                                                          
             if ("0".equals(demographicNo)) {                                                                                                                                                                                             
                 docNoLoc = 1;                                                                                                                                                                                                            
                 statusLoc = 2;                                                                                                                                                                                                           
                 docTypeLoc = 5;                                                                                                                                                                                                          
                 lastNameLoc = 6;                                                                                                                                                                                                         
                 firstNameLoc = 7;                                                                                                                                                                                                        
                 hinLoc = 8;                                                                                                                                                                                                              
                 sexLoc = 9;                                                                                                                                                                                                              
                 moduleLoc = 3;                                                                                                                                                                                                           
                 obsDateLoc = 4;                                                                                                                                                                                                          
                 descriptionLoc = 10;                                                                                                                                                                                                     
                 updateDateLoc = 11;                                                                                                                                                                                                      
             } else if (demographicNo != null && !"".equals(demographicNo)) {                                                                                                                                                             
                 docNoLoc = 1;                                                                                                                                                                                                            
                 statusLoc = 2;                                                                                                                                                                                                           
                 docTypeLoc = 9;                                                                                                                                                                                                          
                 lastNameLoc = 3;                                                                                                                                                                                                         
                 firstNameLoc = 4;                                                                                                                                                                                                        
                 hinLoc = 5;                                                                                                                                                                                                              
                 sexLoc = 6;                                                                                                                                                                                                              
                 moduleLoc = 7;                                                                                                                                                                                                           
                 obsDateLoc = 8;                                                                                                                                                                                                          
                 descriptionLoc = 10;                                                                                                                                                                                                     
                 updateDateLoc = 11;                                                                                                                                                                                                      
             } else {                                                                                                                                                                                                                     
                 docNoLoc = 1;                                                                                                                                                                                                            
                 statusLoc = 2;                                                                                                                                                                                                           
                 docTypeLoc = 9;                                                                                                                                                                                                          
                 lastNameLoc = 3;                                                                                                                                                                                                         
                 firstNameLoc = 4;                                                                                                                                                                                                        
                 hinLoc = 5;                                                                                                                                                                                                              
                 sexLoc = 6;                                                                                                                                                                                                              
                 moduleLoc = 7;                                                                                                                                                                                                           
                 obsDateLoc = 8;                                                                                                                                                                                                          
                 descriptionLoc = 10;                                                                                                                                                                                                     
                 updateDateLoc = 11;                                                                                                                                                                                                      
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Set document properties                                                                                                                                                                                                   
             lbData.segmentID = getStringValue(row[docNoLoc]);                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (demographicNo == null && !providerNo.equals("0")) {                                                                                                                                                                      
                 lbData.acknowledgedStatus = getStringValue(row[statusLoc]);                                                                                                                                                              
             } else {                                                                                                                                                                                                                     
                 lbData.acknowledgedStatus = "U";                                                                                                                                                                                         
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Set patient information                                                                                                                                                                                                   
             lbData.healthNumber = "";                                                                                                                                                                                                    
             lbData.patientName = "Not, Assigned";                                                                                                                                                                                        
             lbData.sex = "";                                                                                                                                                                                                             
                                                                                                                                                                                                                                          
             lbData.isMatchedToPatient = row[lastNameLoc] != null;                                                                                                                                                                        
                                                                                                                                                                                                                                          
             if (lbData.isMatchedToPatient) {                                                                                                                                                                                             
                 lbData.patientName = getStringValue(row[lastNameLoc]) + ", " + getStringValue(row[firstNameLoc]);                                                                                                                        
                 lbData.healthNumber = getStringValue(row[hinLoc]);                                                                                                                                                                       
                 lbData.sex = getStringValue(row[sexLoc]);                                                                                                                                                                                
                 lbData.setLabPatientId(getStringValue(row[moduleLoc]));                                                                                                                                                                  
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Set other properties                                                                                                                                                                                                      
             lbData.accessionNumber = "";                                                                                                                                                                                                 
             lbData.resultStatus = "N";                                                                                                                                                                                                   
                                                                                                                                                                                                                                          
             // Set date information                                                                                                                                                                                                      
             DocumentDao documentDao = (DocumentDao) SpringUtils.getBean(DocumentDao.class);                                                                                                                                              
             Date contentDateTime = null;                                                                                                                                                                                                 
             try {                                                                                                                                                                                                                        
                 contentDateTime = documentDao.findActiveByDocumentNo(Integer.parseInt(getStringValue(row[docNoLoc]))).get(0).getContentdatetime();                                                                                       
             } catch (Exception e) {                                                                                                                                                                                                      
                 logger.error("Error getting content date time", e);                                                                                                                                                                      
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             if (!StringUtils.isNullOrEmpty(getStringValue(row[obsDateLoc]))) {                                                                                                                                                           
                 // If observation is not null, set that as date                                                                                                                                                                          
                 lbData.dateTime = getStringValue(row[obsDateLoc]);                                                                                                                                                                       
                 try {                                                                                                                                                                                                                    
                     lbData.setDateObj(DateUtils.parseDate(getStringValue(row[obsDateLoc]), new String[]{"yyyy-MM-dd"}));                                                                                                                 
                 } catch (Exception e) {                                                                                                                                                                                                  
                     logger.error("Error parsing observation date", e);                                                                                                                                                                   
                 }                                                                                                                                                                                                                        
             } else if (!StringUtils.isNullOrEmpty(getStringValue(row[updateDateLoc]))) {                                                                                                                                                 
                 // Elseif updateDate is not null, set that as date                                                                                                                                                                       
                 lbData.dateTime = getStringValue(row[updateDateLoc]);                                                                                                                                                                    
                 try {                                                                                                                                                                                                                    
                     lbData.setDateObj(DateUtils.parseDate(getStringValue(row[updateDateLoc]), new String[]{"yyyy-MM-dd"}));                                                                                                              
                 } catch (Exception e) {                                                                                                                                                                                                  
                     logger.error("Error parsing update date", e);                                                                                                                                                                        
                 }                                                                                                                                                                                                                        
             } else if (contentDateTime != null) {                                                                                                                                                                                        
                 // Elseif contentDate is not null, set that as date                                                                                                                                                                      
                 SimpleDateFormat dateSqlFormatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");                                                                                                                                         
                 lbData.dateTime = dateSqlFormatter.format(contentDateTime);                                                                                                                                                              
                 lbData.setDateObj(contentDateTime);                                                                                                                                                                                      
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             // Set priority                                                                                                                                                                                                              
             lbData.priority = "Routine";                                                                                                                                                                                                 
                                                                                                                                                                                                                                          
             // Set other fields                                                                                                                                                                                                          
             lbData.requestingClient = "";                                                                                                                                                                                                
             lbData.reportStatus = "F";                                                                                                                                                                                                   
             lbData.finalRes = true;                                                                                                                                                                                                      
                                                                                                                                                                                                                                          
             // Set discipline and description                                                                                                                                                                                            
             lbData.discipline = getStringValue(row[docTypeLoc]);                                                                                                                                                                         
             if (lbData.discipline != null && lbData.discipline.trim().equals("")) {                                                                                                                                                      
                 lbData.discipline = null;                                                                                                                                                                                                
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             lbData.description = getStringValue(row[descriptionLoc]);                                                                                                                                                                    
             if (lbData.description != null && lbData.description.trim().equals("")) {                                                                                                                                                    
                 lbData.description = null;                                                                                                                                                                                               
             }                                                                                                                                                                                                                            
                                                                                                                                                                                                                                          
             lbData.lastUpdateDate = getStringValue(row[updateDateLoc]);                                                                                                                                                                  
             lbData.finalResultsCount = 0;                                                                                                                                                                                                
                                                                                                                                                                                                                                          
             return lbData;                                                                                                                                                                                                               
         } catch (Exception e) {                                                                                                                                                                                                          
             logger.error("Error processing document result row", e);                                                                                                                                                                     
             return null;                                                                                                                                                                                                                 
         }                                                                                                                                                                                                                                
     }                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          
     private String getStringValue(Object value) {                                                                                                                                                                                        
         return value != null ? value.toString() : null;                                                                                                                                                                                  
     }                                                                                                                                                                                                                                    
 }                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                          